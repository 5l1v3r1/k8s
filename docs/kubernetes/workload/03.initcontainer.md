## 三、初始化容器

### 3.1、概述

​		初始化容器（init container）是一种专用的容器，在Pod内的应用容器启动之前运行，并包括一些应用镜像中不存在的实用工具和安装脚本。

​		Pod可以包含多个容器，应用运行在这些容器里面，同时Pod也可以有一个或多个先于应用容器启动的init容器。Init容器与普通的容器非常像，除了以下两点：

- 它们总是运行到完成。
- 每个初始化容器都必须在下一个启动之前成功完成。

​        如果 Pod 的初始化容器失败，Kubernetes 会不断地重启该 Pod，直到初始化容器成功为止。然而，如果 Pod 对应的 `restartPolicy` 值为 Never，它不会重新启动。



### 3.2、与应用容器的区别

​		（1）、初始化容器的运行方式与应用容器不同，它们必须先于应用容器执行完成，当设置了多个初始化容器时，将按顺序逐个运行，并且只有前一个初始化容器运行成功后，才能运行下一个初始化容器。当所有初始化容器都成功运行后，Kubernetes才会初始化Pod的各种信息，并开始创建和运行应用容器。

​		（2）、在初始化容器的定义中也可以设置资源限制、Volume的使用和安全策略等等。但资源限制的设置与应用容器略有不同。

- 如果多个初始化容器都定义了资源请求/资源限制，则取最大的值最为所有初始化容器的资源请求值/资源限制值。
- Pod的有效（effective）资源请求值/资源限制值取以下二者的较大值。
  - 所有应用容器的资源请求值/资源限制值之和。
  - 初始化容器的有效资源请求值/资源限制值。

- 调度算法将基于Pod的有效资源请求值/资源限制值进行计算，也就是初始化容器可以为初始化操作系统预留系统资源，即使后续应用容器无须使用这些资源。
- Pod的有效Qos等级适用于初始化容器和应用容器。
- 资源配额和限制将根据Pod的有效资源请求值/资源限制值计算生效。
- Pod级别的cgroup将基于Pod的有效资源请求/限制，与调度机制一致。

​		（3）、初始化容器不能设置readinessProbe探针，因为必须在它们成功运行后才能继续运行在Pod中定义的普通容器。

在Pod重新启动时，初始化将会重新运行，常见的Pod重启场景：

- 初始化容器的镜像被更新时，初始化容器将会重新运行，导致Pod重启。仅更新应用容器的镜像，只会使得应用容器被重启。
- Pod的infrastructure容器更新时，Pod将会重启。
- 若Pod中的所有应用容器都终止了，并且RestartPolicy=Always，则Pod会重启。